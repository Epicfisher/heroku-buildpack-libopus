#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

# Fail fast and fail hard.
set -eo pipefail
[ "$BUILDPACK_XTRACE" ] && set -o xtrace

# Variables
BP_NAME="libopus"

BIN_DIR=$(cd $(dirname $0); pwd)
BUILD_DIR=$1
VENDOR_DIR="$BUILD_DIR/.heroku/vendor"

SOURCE_TARBALL='https://github.com/xiph/opus/archive/master.tar.gz'

echo "Building $BP_NAME..."

# Get source
echo "Downloading Source..."
curl -L "$SOURCE_TARBALL" | tar -zxv --strip=1

# Build
echo "Now Building..."
cd opus-master
./autogen.sh
./configure --prefix=/app/.heroku/vendor    \
  --disable-static &&
make

# Create .profile script for runtime environment
PROFILE_PATH="$BUILD_DIR/.profile.d/$BP_NAME.sh"
append-env() { echo "[[ \":\$$1:\" != *\":$2:\"* ]] && export $1=\"\$$1:$2\"" >> $PROFILE_PATH; }

append-env PATH '/app/.heroku/vendor/bin'
append-env LIBRARY_PATH '/app/.heroku/vendor/lib'
append-env LD_LIBRARY_PATH '/app/.heroku/vendor/lib'
